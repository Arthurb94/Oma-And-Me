<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>Combined Application</title>
</head>
<body>
    <!-- Page 1: Select Gender -->
    <div id="page1" class="page">
        <div class="container">
            <h1>Select Your Gender</h1>
            <p>Please select your gender and accept our Privacy Policy to continue.</p>
            <div class="gender-selection">
                <button class="gender-btn" onclick="selectGender('male')">Male</button>
                <button class="gender-btn" onclick="selectGender('female')">Female</button>
            </div>
            <p class="privacy-policy">
                By continuing, you agree to our <a href="privacy-policy.html">Privacy Policy</a>.
            </p>
        </div>
    </div>


    <!-- Page 2: Photo Instructions (Front View) -->
    <div id="page2" class="page" style="display: none;">
        <div class="container">
            <h1>Photo Instructions</h1>
            <p>Please follow the examples below to take clear and accurate photos.</p>
            <div class="photo-example">
                <h2>Front View</h2>
                <img src="front-view-example.jpg" alt="Front View Example">
            </div>
            <button class="continue-btn" onclick="navigateTo('page3')">Continue</button>
        </div>
    </div>


    <!-- Page 3: Take Front View Photo -->
    <div id="page3" class="page" style="display: none;">
        <div class="container">
            <h1>Take Your Front View Photo</h1>
            <p>Ensure your photo is clear and well-lit.</p>
            <video id="videoFront" autoplay style="display:none;"></video>
            <button id="captureBtnFront" class="capture-btn" onclick="startCapture('front')">Capture Photo</button>
            <button id="retakeBtnFront" class="retake-btn" onclick="retakePhoto('front')" style="display:none;">Retake</button>
            <button id="confirmBtnFront" class="confirm-btn" onclick="confirmPhoto('front')" style="display:none;">Confirm</button>
            <canvas id="canvasFront" style="display:none;"></canvas>
            <img id="previewFront" style="display:none; width:100%; border-radius:5px; margin-bottom:10px;" alt="Front View Preview">
        </div>
    </div>


    <!-- Page 4: Photo Instructions (Top View) -->
    <div id="page4" class="page" style="display: none;">
        <div class="container">
            <h1>Photo Instructions</h1>
            <p>Please follow the examples below to take clear and accurate photos.</p>
            <div class="photo-example">
                <h2>Top View</h2>
                <img src="top-view-example.jpg" alt="Top View Example">
            </div>
            <button class="continue-btn" onclick="navigateTo('page5')">Continue</button>
        </div>
    </div>


    <!-- Page 5: Take Top View Photo -->
    <div id="page5" class="page" style="display: none;">
        <div class="container">
            <h1>Take Your Top View Photo</h1>
            <p>Ensure your photo is clear and well-lit.</p>
            <video id="videoTop" autoplay style="display:none;"></video>
            <button id="captureBtnTop" class="capture-btn" onclick="startCapture('top')">Capture Photo</button>
            <button id="retakeBtnTop" class="retake-btn" onclick="retakePhoto('top')" style="display:none;">Retake</button>
            <button id="confirmBtnTop" class="confirm-btn" onclick="confirmPhoto('top')" style="display:none;">Confirm</button>
            <canvas id="canvasTop" style="display:none;"></canvas>
            <img id="previewTop" style="display:none; width:100%; border-radius:5px; margin-bottom:10px;" alt="Top View Preview">
        </div>
    </div>


    <!-- Page 6: Photo Instructions (Right View) -->
    <div id="page6" class="page" style="display: none;">
        <div class="container">
            <h1>Photo Instructions</h1>
            <p>Please follow the examples below to take clear and accurate photos.</p>
            <div class="photo-example">
                <h2>Right View</h2>
                <img src="right-view-example.jpg" alt="Right View Example">
            </div>
            <button class="continue-btn" onclick="navigateTo('page7')">Continue</button>
        </div>
    </div>


    <!-- Page 7: Take Right View Photo -->
    <div id="page7" class="page" style="display: none;">
        <div class="container">
            <h1>Take Your Right View Photo</h1>
            <p>Ensure your photo is clear and well-lit.</p>
            <video id="videoRight" autoplay style="display:none;"></video>
            <button id="captureBtnRight" class="capture-btn" onclick="startCapture('right')">Capture Photo</button>
            <button id="retakeBtnRight" class="retake-btn" onclick="retakePhoto('right')" style="display:none;">Retake</button>
            <button id="confirmBtnRight" class="confirm-btn" onclick="confirmPhoto('right')" style="display:none;">Confirm</button>
            <canvas id="canvasRight" style="display:none;"></canvas>
            <img id="previewRight" style="display:none; width:100%; border-radius:5px; margin-bottom:10px;" alt="Right View Preview">
        </div>
    </div>


    <!-- Page 8: Photo Instructions (Left View) -->
    <div id="page8" class="page" style="display: none;">
        <div class="container">
            <h1>Photo Instructions</h1>
            <p>Please follow the examples below to take clear and accurate photos.</p>
            <div class="photo-example">
                <h2>Left View</h2>
                <img src="left-view-example.jpg" alt="Left View Example">
            </div>
            <button class="continue-btn" onclick="navigateTo('page9')">Continue</button>
        </div>
    </div>


    <!-- Page 9: Take Left View Photo -->
    <div id="page9" class="page" style="display: none;">
        <div class="container">
            <h1>Take Your Left View Photo</h1>
            <p>Ensure your photo is clear and well-lit.</p>
            <video id="videoLeft" autoplay style="display:none;"></video>
            <button id="captureBtnLeft" class="capture-btn" onclick="startCapture('left')">Capture Photo</button>
            <button id="retakeBtnLeft" class="retake-btn" onclick="retakePhoto('left')" style="display:none;">Retake</button>
            <button id="confirmBtnLeft" class="confirm-btn" onclick="confirmPhoto('left')" style="display:none;">Confirm</button>
            <canvas id="canvasLeft" style="display:none;"></canvas>
            <img id="previewLeft" style="display:none; width:100%; border-radius:5px; margin-bottom:10px;" alt="Left View Preview">
        </div>
    </div>


    <!-- Page 10: Review Photos -->
    <div id="page10" class="page" style="display: none;">
        <div class="container">
            <h1>Review Your Photos</h1>
            <div class="photo-preview">
                <div>
                    <h2>Front View</h2>
                    <img id="frontViewPreview" src="" alt="Front View Photo">
                </div>
                <div>
                    <h2>Top View</h2>
                    <img id="topViewPreview" src="" alt="Top View Photo">
                </div>
                <div>
                    <h2>Right View</h2>
                    <img id="rightViewPreview" src="" alt="Right View Photo">
                </div>
                <div>
                    <h2>Left View</h2>
                    <img id="leftViewPreview" src="" alt="Left View Photo">
                </div>
            </div>
            <div class="button-group">
                <button onclick="sendPhotos()">Send Photos</button>
            </div>
        </div>
    </div>


    <!-- Page 11: Loading -->
    <div id="page11" class="page" style="display: none;">
        <div class="loader"></div>
        <h1>Loading, please wait...</h1>
    </div>


    <!-- Page 12: API Results -->
    <div id="page12" class="page" style="display: none;">
        <div class="container">
            <h1>API Results</h1>
            <h2>Front View</h2>
            <textarea id="frontResult" readonly></textarea>
        </div>
    </div>


    <script>
        // Navigation logic
        function navigateTo(pageId) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.style.display = 'none');
            document.getElementById(pageId).style.display = 'block';
        }


        // Gender selection logic
        let selectedGender = '';


        function selectGender(gender) {
            selectedGender = gender;
            navigateTo('page2');
        }


        // Start and capture camera
        function startCapture(view) {
            const videoElement = document.getElementById(`video${capitalize(view)}`);
            const captureBtn = document.getElementById(`captureBtn${capitalize(view)}`);
            const retakeBtn = document.getElementById(`retakeBtn${capitalize(view)}`);
            const confirmBtn = document.getElementById(`confirmBtn${capitalize(view)}`);
            const previewElement = document.getElementById(`preview${capitalize(view)}`);


            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    videoElement.srcObject = stream;
                    videoElement.style.display = 'block';
                    captureBtn.style.display = 'block';
                    retakeBtn.style.display = 'none';
                    confirmBtn.style.display = 'none';
                    captureBtn.onclick = () => {
                        const canvasElement = document.getElementById(`canvas${capitalize(view)}`);
                        const context = canvasElement.getContext('2d');
                        canvasElement.width = videoElement.videoWidth;
                        canvasElement.height = videoElement.videoHeight;
                        context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
                        capturedPhotos[view] = canvasElement.toDataURL('image/jpeg');


                        // Stop the video stream
                        const tracks = stream.getTracks();
                        tracks.forEach(track => track.stop());
                        videoElement.srcObject = null;


                        videoElement.style.display = 'none';
                        previewElement.src = capturedPhotos[view];
                        previewElement.style.display = 'block';
                        captureBtn.style.display = 'none';
                        retakeBtn.style.display = 'block';
                        confirmBtn.style.display = 'block';
                    };
                })
                .catch(error => {
                    console.error('Error accessing the camera:', error);
                });
        }


        // Photo capture logic
        let capturedPhotos = {
            front: null,
            top: null,
            right: null,
            left: null
        };


        function retakePhoto(view, fromReviewPage = false, returnToReviewPage = false) {
            const videoElement = document.getElementById(`video${capitalize(view)}`);
            const captureBtn = document.getElementById(`captureBtn${capitalize(view)}`);
            const retakeBtn = document.getElementById(`retakeBtn${capitalize(view)}`);
            const confirmBtn = document.getElementById(`confirmBtn${capitalize(view)}`);
            const previewElement = document.getElementById(`preview${capitalize(view)}`);


            capturedPhotos[view] = null;
            videoElement.style.display = 'none';
            previewElement.style.display = 'none';
            captureBtn.style.display = 'block';
            retakeBtn.style.display = 'none';
            confirmBtn.style.display = 'none';


            const captureAndReturn = () => {
                startCapture(view);
                confirmBtn.onclick = () => {
                    const canvasElement = document.getElementById(`canvas${capitalize(view)}`);
                    const context = canvasElement.getContext('2d');
                    canvasElement.width = videoElement.videoWidth;
                    canvasElement.height = videoElement.videoHeight;
                    context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
                    capturedPhotos[view] = canvasElement.toDataURL('image/jpeg');


                    // Stop the video stream
                    const tracks = videoElement.srcObject.getTracks();
                    tracks.forEach(track => track.stop());
                    videoElement.srcObject = null;


                    videoElement.style.display = 'none';
                    previewElement.src = capturedPhotos[view];
                    previewElement.style.display = 'block';
                    captureBtn.style.display = 'none';
                    retakeBtn.style.display = 'block';
                    confirmBtn.style.display = 'block';


                    // Update the photo in the review page
                    const previewElementReview = document.getElementById(`${view}ViewPreview`);
                    previewElementReview.src = capturedPhotos[view];


                    // Navigate to the review page
                    navigateTo('page10');
                };
            };


            if (fromReviewPage) {
                navigateTo(`page${view === 'front' ? 3 : view === 'top' ? 5 : view === 'right' ? 7 : 9}`);
                setTimeout(captureAndReturn, 500); // Ensure capture function is called after navigation
            } else {
                captureAndReturn();
            }
        }


        // Update button onclicks in page 10 to use the new parameter
        document.querySelector("button[onclick='retakePhoto(\"front\", true)']").onclick = () => retakePhoto('front', true, true);
        document.querySelector("button[onclick='retakePhoto(\"top\", true)']").onclick = () => retakePhoto('top', true, true);
        document.querySelector("button[onclick='retakePhoto(\"right\", true)']").onclick = () => retakePhoto('right', true, true);
        document.querySelector("button[onclick='retakePhoto(\"left\", true)']").onclick = () => retakePhoto('left', true, true);


        function confirmPhoto(view, returnToReviewPage = false) {
            const previewElement = document.getElementById(`${view}ViewPreview`);
            previewElement.src = capturedPhotos[view];
            if (returnToReviewPage) {
                navigateTo('page10');
            } else {
                if (view === 'front') navigateTo('page4');
                if (view === 'top') navigateTo('page6');
                if (view === 'right') navigateTo('page8');
                if (view === 'left') navigateTo('page10');
            }
        }


        // Update confirm button onclicks to include returnToReviewPage parameter
        document.getElementById('confirmBtnFront').onclick = () => confirmPhoto('front', true);
        document.getElementById('confirmBtnTop').onclick = () => confirmPhoto('top', true);
        document.getElementById('confirmBtnRight').onclick = () => confirmPhoto('right', true);
        document.getElementById('confirmBtnLeft').onclick = () => confirmPhoto('left', true);




        function sendPhotos() {
            navigateTo('page11');
            const frontViewPhoto = capturedPhotos.front;
            localStorage.setItem('currentPhoto', frontViewPhoto);
            localStorage.setItem('currentViewType', 'front');
            fetchApiData(frontViewPhoto, 'front');

            const topViewPhoto = capturedPhotos.top;
            localStorage.setItem('currentPhoto', topViewPhoto);
            localStorage.setItem('currentViewType', 'top');
            fetchApiData(topViewPhoto, 'top');
        }


        async function fetchApiData(frontViewPhoto, topViewPhoto) {
            try {
                const response = await fetch("https://tv1wdm122i.execute-api.eu-west-3.amazonaws.com/default/oma", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ file_front: frontViewPhoto.split(',')[1], file_top: topViewPhoto.split(',')[1] })
                });


                if (!response.ok) {
                    throw new Error('HTTP error! Status: ${response.status}');
                }


                const data = await response.json();


                // Store the result in local storage
                localStorage.setItem('result',JSON.stringify(data));
                navigateTo('page12');
            } catch (error) {
                localStorage.setItem('result', 'Error: ${error.message}');
                navigateTo('page12');
            }
        }


        function displayResults() {
            const result = localStorage.getItem('result') || 'No data';
            document.getElementById('result').value = result;


            // Clear results from localStorage after displaying
            localStorage.removeItem('result');
        }


        function capitalize(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }


        window.addEventListener('load', () => {
            const result = localStorage.getItem('result');
            if (result) {
                document.getElementById('result').value = result;
                localStorage.removeItem('result');
            }
        });
    </script>
</body>
</html>

