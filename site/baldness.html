<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>Combined Application</title>
</head>
<body>
    <!-- Page 1: Select Gender -->
    <div id="page1" class="page">
        <div class="container">
            <h1>Select Your Gender</h1>
            <p>Please select your gender and accept our Privacy Policy to continue.</p>
            <div class="gender-selection">
                <button class="gender-btn" onclick="selectGender('male')">Male</button>
                <button class="gender-btn" onclick="selectGender('female')">Female</button>
            </div>
            <p class="privacy-policy">
                By continuing, you agree to our <a href="privacy-policy.html">Privacy Policy</a>.
            </p>
        </div>
    </div>

    <!-- Page 2: Photo Instructions (Front View) -->
    <div id="page2" class="page" style="display: none;">
        <div class="container">
            <h1>Photo Instructions</h1>
            <p>Please follow the examples below to take clear and accurate photos.</p>
            <div class="photo-example">
                <h2>Front View</h2>
                <img src="front-view-example.jpg" alt="Front View Example">
            </div>
            <button class="continue-btn" onclick="navigateTo('page3')">Continue</button>
        </div>
    </div>

    <!-- Page 3: Take Front View Photo -->
    <div id="page3" class="page" style="display: none;">
        <div class="container">
            <h1>Take Your Front View Photo</h1>
            <p>Ensure your photo is clear and well-lit.</p>
            <video id="videoFront" autoplay></video>
            <button id="captureBtnFront" class="capture-btn" onclick="capturePhoto('front')">Capture Photo</button>
            <button id="retakeBtnFront" class="retake-btn" onclick="retakePhoto('front')" style="display:none;">Retake</button>
            <button id="confirmBtnFront" class="confirm-btn" onclick="confirmPhoto('front')" style="display:none;">Confirm</button>
            <canvas id="canvasFront" style="display:none;"></canvas>
        </div>
    </div>

    <!-- Page 4: Photo Instructions (Top View) -->
    <div id="page4" class="page" style="display: none;">
        <div class="container">
            <h1>Photo Instructions</h1>
            <p>Please follow the examples below to take clear and accurate photos.</p>
            <div class="photo-example">
                <h2>Top View</h2>
                <img src="top-view-example.jpg" alt="Top View Example">
            </div>
            <button class="continue-btn" onclick="navigateTo('page5')">Continue</button>
        </div>
    </div>

    <!-- Page 5: Take Top View Photo -->
    <div id="page5" class="page" style="display: none;">
        <div class="container">
            <h1>Take Your Top View Photo</h1>
            <p>Ensure your photo is clear and well-lit.</p>
            <video id="videoTop" autoplay></video>
            <button id="captureBtnTop" class="capture-btn" onclick="capturePhoto('top')">Capture Photo</button>
            <button id="retakeBtnTop" class="retake-btn" onclick="retakePhoto('top')" style="display:none;">Retake</button>
            <button id="confirmBtnTop" class="confirm-btn" onclick="confirmPhoto('top')" style="display:none;">Confirm</button>
            <canvas id="canvasTop" style="display:none;"></canvas>
        </div>
    </div>

    <!-- Page 6: Review Photos -->
    <div id="page6" class="page" style="display: none;">
        <div class="container">
            <h1>Review Your Photos</h1>
            <div class="photo-preview">
                <div>
                    <h2>Front View</h2>
                    <img id="frontViewPreview" src="" alt="Front View Photo">
                </div>
                <div>
                    <h2>Top View</h2>
                    <img id="topViewPreview" src="" alt="Top View Photo">
                </div>
            </div>
            <div class="button-group">
                <button onclick="retakePhoto('front')">Retake Front View</button>
                <button onclick="retakePhoto('top')">Retake Top View</button>
            </div>
            <div class="button-group">
                <button onclick="sendPhotos()">Send Photos</button>
            </div>
        </div>
    </div>

    <!-- Page 7: Loading -->
    <div id="page7" class="page" style="display: none;">
        <div class="loader"></div>
        <h1>Loading, please wait...</h1>
    </div>

    <!-- Page 8: API Results -->
    <div id="page8" class="page" style="display: none;">
        <div class="container">
            <h1>API Results</h1>
            <h2>Front View</h2>
            <textarea id="frontResult" readonly></textarea>
            <!-- <h2>Top View</h2>
            <textarea id="topResult" readonly></textarea> -->
        </div>
    </div>

    <script>
        function navigateTo(pageId) {
            document.querySelectorAll('.page').forEach(page => page.style.display = 'none');
            document.getElementById(pageId).style.display = 'block';
            if (pageId === 'page3' || pageId === 'page5') {
                initializeCamera(pageId);
            } else if (pageId === 'page8') {
                displayResults();
            }
        }

        function selectGender(gender) {
            localStorage.setItem('gender', gender);
            navigateTo('page2');
        }

        function initializeCamera(pageId) {
            let videoElement = null;
            if (pageId === 'page3') {
                videoElement = document.getElementById('videoFront');
            } else if (pageId === 'page5') {
                videoElement = document.getElementById('videoTop');
            }

            if (videoElement) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(mediaStream => {
                        videoElement.srcObject = mediaStream;
                    })
                    .catch(error => {
                        console.error('Error accessing the camera:', error);
                    });
            }
        }

        function capturePhoto(view) {
            const video = document.getElementById(`video${capitalize(view)}`);
            const canvas = document.getElementById(`canvas${capitalize(view)}`);
            const captureBtn = document.getElementById(`captureBtn${capitalize(view)}`);
            const retakeBtn = document.getElementById(`retakeBtn${capitalize(view)}`);
            const confirmBtn = document.getElementById(`confirmBtn${capitalize(view)}`);
            const context = canvas.getContext('2d');

            if (!context) {
                console.error('Failed to get 2D context');
                return;
            }
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Stop all video tracks to freeze the video
            const stream = video.srcObject;
            stream.getTracks().forEach(track => track.stop());

            captureBtn.style.display = 'none';
            retakeBtn.style.display = 'block';
            confirmBtn.style.display = 'block';

            // Show the captured image on the video element
            video.style.display = 'none';
            const img = document.createElement('img');
            img.id = 'capturedImage';
            img.src = canvas.toDataURL('image/jpeg');
            img.style.width = '100%';
            img.style.borderRadius = '5px';
            img.style.marginBottom = '10px';
            video.parentNode.insertBefore(img, video.nextSibling);
        }

        // retake the photo after the 
        function retakePhoto(view) {
            const video = document.getElementById(`video${capitalize(view)}`);
            const captureBtn = document.getElementById(`captureBtn${capitalize(view)}`);
            const retakeBtn = document.getElementById(`retakeBtn${capitalize(view)}`);
            const confirmBtn = document.getElementById(`confirmBtn${capitalize(view)}`);

            navigator.mediaDevices.getUserMedia({ video: true })
                .then(mediaStream => {
                    video.srcObject = mediaStream;
                    video.style.display = 'block';
                    const img = document.getElementById('capturedImage');
                    if (img) {
                        img.remove();
                    }
                })
                .catch(error => {
                    console.error('Error accessing the camera:', error);
                });

            captureBtn.style.display = 'block';
            retakeBtn.style.display = 'none';
            confirmBtn.style.display = 'none';
        }

        // save the photo after the user confirms the pic
        function confirmPhoto(view) {
            const canvas = document.getElementById(`canvas${capitalize(view)}`);
            const dataURL = canvas.toDataURL('image/jpeg');
            localStorage.setItem(`${view}ViewPhoto`, dataURL);
            if (view === 'front') {
                navigateTo('page4');
            } else if (view === 'top') {
                navigateTo('page6');
            }
        }

        // prepare photos to be send to the lambda api
        function sendPhotos() {
            navigateTo('page7');
            const frontViewPhoto = localStorage.getItem('frontViewPhoto');
            localStorage.setItem('currentPhoto', frontViewPhoto);
            localStorage.setItem('currentViewType', 'front');
            fetchApiData(frontViewPhoto, 'front');
        }

        // request the lambda api
        async function fetchApiData(base64Image, viewType) {
            try {
                const response = await fetch("https://tv1wdm122i.execute-api.eu-west-3.amazonaws.com/default/oma", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ file: base64Image.split(',')[1]})
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();

                // Store the result in local storage
                localStorage.setItem(`${viewType}Result`, JSON.stringify(data));
                navigateTo('page8');
            } catch (error) {
                localStorage.setItem(`${viewType}Result`, `Error: ${error.message}`);
                navigateTo('page8');
            }
        }

        function displayResults() {
            const frontResult = localStorage.getItem('frontResult') || 'No data';
            document.getElementById('frontResult').value = frontResult;

            // Uncomment below if top view result is to be displayed
            const topResult = localStorage.getItem('topResult') || 'No data';
            document.getElementById('topResult').value = topResult;

            // Clear results from localStorage after displaying
            localStorage.removeItem('frontResult');
            localStorage.removeItem('topResult');
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        window.addEventListener('load', () => {
            const frontResult = localStorage.getItem('frontResult');
            if (frontResult) {
                document.getElementById('frontResult').value = frontResult;
                localStorage.removeItem('frontResult');
            }
        });
    </script>
</body>
</html>